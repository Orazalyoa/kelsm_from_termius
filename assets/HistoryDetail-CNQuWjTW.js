import{_ as tt}from"./_plugin-vue_export-helper-BgbHP9iJ.js";/* empty css              *//* empty css              */import{V as et,_ as st,r as N,c as k,e as at,P as h,Q as d,j as m,W as a,u as l,a4 as g,Z as f,B as ot,Y as n,$ as v,y as nt,F as T,X as P}from"./vue-vendor-DEVBTxx0.js";import{u as it,b as ct}from"./index-tPAe9Dy4.js";import{b as rt,c as lt,u as ut}from"./consultation-CmWwUlcj.js";import{C as dt}from"./CustomNavBar-BJGtUQrX.js";import{Icon as _t,Step as ht,Steps as mt,Loading as vt,Button as pt,showToast as C,showConfirmDialog as U,showLoadingToast as F,showSuccessToast as I}from"./vant-CoNmWDyF.js";import"./index_logo-B4Lpufyb.js";const yt={class:"history-detail-page"},ft={class:"page-content"},gt={key:1,class:"detail-content"},wt={class:"detail-header"},bt={class:"detail-title"},kt={class:"submission-date"},Ct={class:"section"},Bt={class:"section-title"},Mt={class:"description-item"},xt={class:"desc-label"},Lt={class:"desc-value"},$t={class:"description-item"},zt={class:"desc-label"},At={class:"desc-value"},St={key:0,class:"description-item"},Dt={class:"desc-label"},Nt={class:"desc-value"},Tt={class:"description-text"},Pt={key:0,class:"section"},Ut={class:"section-title"},Ft={class:"file-list"},It=["onClick"],Vt={class:"file-info"},Zt={class:"file-name"},Ht={class:"file-size"},Rt={key:1,class:"section"},Kt={class:"section-title"},jt={key:0},Et={class:"action-container"},Gt={__name:"HistoryDetail",setup(Qt){const w=et(),V=st(),{t,locale:Z}=it(),x=ct(),s=N({id:null,title:"",status:"pending",desc:"",description:"",creator:"",created_by:null,assigned_lawyer_id:null,category:"",expert_name:"",files:[],chatAvailable:!1,chat_id:null,created_at:null,status_logs:[]}),B=N(!0),L=k(()=>{var i;if(s.value.status!=="in_progress")return!1;const e=(i=x.user)==null?void 0:i.id;return e&&s.value.created_by===e}),$=k(()=>{var i;if(s.value.status!=="archived")return!1;const e=(i=x.user)==null?void 0:i.id;return e&&s.value.created_by===e}),H=k(()=>t(`status.${s.value.status}`)||s.value.status),z=()=>({"zh-Hans":"zh-CN",en:"en-US",ru:"ru-RU",kk:"kk-KZ"})[Z.value]||"en-US",R=k(()=>s.value.created_at?new Date(s.value.created_at).toLocaleDateString(z(),{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",timeZone:"Asia/Almaty"}):"-"),K=e=>{if(!e)return t("common.unknown_status")||"-";const i=`status.${e}`,u=t(i);return u!==i?u:e},j=e=>{if(!e)return t("common.uncategorized")||"-";const i=`topic_types.${e}`,u=t(i);return u!==i?u:e},E=e=>{if(!e)return"";const i=/^(?:Assigned to lawyer|分配给律师):\s*(.+)$/i,u=e.match(i);if(u)return t("status_log_notes.assigned_to_lawyer",{lawyer:u[1]});const c=/^Consultation assigned to\s*(.+)$/i,o=e.match(c);if(o)return t("status_log_notes.consultation_assigned",{lawyer:o[1]});const r=/^添加律师:\s*(.+)$/,p=e.match(r);if(p)return t("status_log_notes.lawyer_added",{lawyer:p[1]});const _=/^移除律师:\s*(.+)$/,y=e.match(_);if(y)return t("status_log_notes.lawyer_removed",{lawyer:y[1]});const A=/^Consultation status changed to:\s*(.+)$/i,S=e.match(A);if(S)return t("status_log_notes.status_changed_to",{status:S[1]});if(e==="Consultation created")return t("status_log_notes.consultation_created");if(e==="客户归档咨询")return t("status_log_notes.client_archived");if(e==="客户恢复咨询")return t("status_log_notes.client_unarchived");const J=/^客户撤回:\s*(.+)$/,D=e.match(J);if(D)return t("status_log_notes.client_withdraw",{reason:D[1]});const O=/^优先级从\s*(\w+)\s*提升至\s*(\w+):\s*(.+)$/,b=e.match(O);return b?t("status_log_notes.priority_escalated",{old:b[1],new:b[2],reason:b[3]}):e},G=e=>e?new Date(e).toLocaleString(z(),{timeZone:"Asia/Almaty"}):"",Q=e=>{e.url?window.open(e.url,"_blank"):C(t("common.file_url_unavailable"))},W=async()=>{try{await U({title:t("history.archive_confirm_title"),message:t("history.archive_confirm_message"),confirmButtonText:t("common.confirm"),cancelButtonText:t("common.cancel")}),F({message:t("common.processing"),forbidClick:!0,className:"orange-toast"}),await lt(s.value.id),I(t("history.archived_successfully")),await M()}catch(e){e!=="cancel"&&C(e.message||t("common.operation_failed"))}},X=async()=>{try{await U({title:t("history.unarchive_confirm_title"),message:t("history.unarchive_confirm_message"),confirmButtonText:t("common.confirm"),cancelButtonText:t("common.cancel")}),F({message:t("common.processing"),forbidClick:!0,className:"orange-toast"}),await ut(s.value.id),I(t("history.unarchived_successfully")),await M()}catch(e){e!=="cancel"&&C(e.message||t("common.operation_failed"))}},Y=()=>{s.value.chat_id?w.push({name:"ChatDetail",params:{id:s.value.chat_id}}):C(t("history.chat_not_available"))},M=async()=>{var i,u;const e=V.params.id;if(!e){w.back();return}B.value=!0;try{const c=await rt(e);if(c.success&&c.data){const o=c.data;s.value={id:o.id,title:o.title,status:o.status,desc:o.description,description:o.description,creator:o.creatorName||((i=o.creator)==null?void 0:i.full_name)||t("common.system_auto_created"),created_by:o.created_by,assigned_lawyer_id:o.assigned_lawyer_id,category:o.topic_type||t("common.uncategorized"),expert_name:((u=o.assignedLawyer)==null?void 0:u.full_name)||"",files:(o.files||[]).map(r=>({id:r.id,name:r.file_name,size:q(r.file_size),url:r.download_url||(r.file_path?`/api/consultations/${o.id}/files/${r.id}`:null)})),chatAvailable:o.chatAvailable||!!o.chat_id,chat_id:o.chat_id,created_at:o.created_at,status_logs:(o.statusLogs||o.status_logs||[]).map(r=>({status:r.new_status||r.status,old_status:r.old_status,created_at:r.created_at,note:r.note||r.reason||""}))}}else w.back()}catch(c){console.error("加载详情失败:",c),w.back()}finally{B.value=!1}},q=e=>{if(!e)return"0 B";const i=1024,u=["B","KB","MB","GB"],c=Math.floor(Math.log(e)/Math.log(i));return Math.round(e/Math.pow(i,c)*100)/100+" "+u[c]};return at(()=>{M()}),(e,i)=>{const u=vt,c=_t,o=ht,r=mt,p=pt;return d(),h("div",yt,[m(dt,{title:l(t)("history.detail"),"show-logo":!1},null,8,["title"]),a("div",ft,[B.value?(d(),g(u,{key:0,class:"loading-container",vertical:""},{default:f(()=>[ot(n(l(t)("common.loading")),1)]),_:1})):(d(),h("div",gt,[a("div",wt,[a("h2",bt,n(s.value.title||l(t)("history.detail_title")),1),a("div",{class:nt(["state-badge",`status-${s.value.status}`])},n(H.value),3)]),a("div",kt,[m(c,{name:"clock-o",size:"16",color:"#666"}),a("span",null,n(l(t)("history.submission_date"))+n(R.value),1)]),a("div",Ct,[a("h3",Bt,n(l(t)("history.task_description")),1),a("div",Mt,[a("span",xt,n(l(t)("history.creator")),1),a("span",Lt,n(s.value.creator||l(t)("common.system_auto_created")),1)]),a("div",$t,[a("span",zt,n(l(t)("history.category")),1),a("span",At,n(j(s.value.category)),1)]),s.value.expert_name?(d(),h("div",St,[a("span",Dt,n(l(t)("history.responsible_expert")),1),a("span",Nt,n(s.value.expert_name),1)])):v("",!0),a("div",Tt,n(s.value.description||s.value.desc||l(t)("history.no_description")),1)]),s.value.files&&s.value.files.length>0?(d(),h("div",Pt,[a("h3",Ut,n(l(t)("history.files_and_attachments")),1),a("div",Ft,[(d(!0),h(T,null,P(s.value.files,(_,y)=>(d(),h("div",{key:y,class:"file-item",onClick:A=>Q(_)},[m(c,{name:"description",size:"24",color:"#0066FF"}),a("div",Vt,[a("span",Zt,n(_.name),1),a("span",Ht,n(_.size),1)]),m(c,{name:"arrow-down",size:"20",color:"#999"})],8,It))),128))])])):v("",!0),s.value.status_logs&&s.value.status_logs.length>0?(d(),h("div",Rt,[a("h3",Kt,n(l(t)("history.status_change_log")),1),m(r,{direction:"vertical",active:s.value.status_logs.length},{default:f(()=>[(d(!0),h(T,null,P(s.value.status_logs,(_,y)=>(d(),g(o,{key:y},{default:f(()=>[a("h3",null,n(K(_.status)),1),a("p",null,n(G(_.created_at)),1),_.note?(d(),h("p",jt,n(E(_.note)),1)):v("",!0)]),_:2},1024))),128))]),_:1},8,["active"])])):v("",!0),a("div",Et,[L.value?(d(),g(p,{key:0,type:"warning",block:"",round:"",class:"action-btn",onClick:W},{default:f(()=>[m(c,{name:"passed"}),a("span",null,n(l(t)("history.archive")),1)]),_:1})):v("",!0),$.value?(d(),g(p,{key:1,type:"success",block:"",round:"",class:"action-btn",onClick:X},{default:f(()=>[m(c,{name:"replay"}),a("span",null,n(l(t)("history.unarchive")),1)]),_:1})):v("",!0),!L.value&&!$.value?(d(),g(p,{key:2,type:"primary",block:"",round:"",class:"action-btn",disabled:!s.value.chatAvailable&&!s.value.chat_id,onClick:Y},{default:f(()=>[m(c,{name:"chat-o"}),a("span",null,n(s.value.chatAvailable||s.value.chat_id?l(t)("history.enter_chat"):l(t)("history.chat_not_available")),1)]),_:1},8,["disabled"])):v("",!0)])]))])])}}},ae=tt(Gt,[["__scopeId","data-v-abd7eb91"]]);export{ae as default};
