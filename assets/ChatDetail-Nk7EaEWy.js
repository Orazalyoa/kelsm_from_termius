import{_ as re}from"./_plugin-vue_export-helper-BgbHP9iJ.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import{V as ce,_ as de,r as v,c as R,e as ue,P as r,Q as n,j as p,W as d,u as m,Y as _,$ as h,F as b,X as C,Z as P,a4 as f,y as O,B as _e}from"./vue-vendor-DEVBTxx0.js";import{u as me,b as ve,o as G,p as pe,q as Q,r as he,t as fe,w as ge,x as ke}from"./index-tPAe9Dy4.js";import{e as ye}from"./errorHandler-D1LKPKx3.js";import{g as W}from"./avatar-BoreVJuD.js";import{NavBar as we,Icon as be,Tab as Ce,Empty as Me,Image as xe,Tabs as ze,Loading as Be,Popup as Fe,showToast as M,showImagePreview as je}from"./vant-CoNmWDyF.js";const Le={class:"chat-detail-page"},Re={class:"section"},Pe={class:"section-title"},$e={class:"participant-list"},Ee={class:"participant-avatar"},Ie={key:1,class:"avatar-placeholder"},Ue={class:"participant-info"},De={class:"participant-name"},Se={key:0,class:"participant-role"},Te={class:"add-text"},Ne={key:0},Ve={key:1,class:"media-grid"},Ae=["onClick"],qe={key:1,class:"file-list"},Ke=["onClick"],Oe={class:"file-info"},Ge={class:"file-name-row"},Qe={class:"file-name"},We={class:"file-size"},Xe={key:2,class:"links-list"},Ye=["onClick"],Ze={class:"link-info"},He={class:"link-title"},Je={class:"link-url"},et={class:"member-picker"},tt={class:"picker-header"},at={class:"picker-title"},st={class:"picker-content"},nt={key:2,class:"member-list"},ot=["onClick"],it={class:"member-avatar"},lt={key:1,class:"avatar-placeholder"},rt={class:"member-info"},ct={class:"member-name"},dt={key:0,class:"member-email"},ut={__name:"ChatDetail",setup(_t){const X=ce(),Y=de(),{t:c}=me(),Z=ve(),S=v("media"),g=v(Y.params.id),T=v(!1),H=v(null),$=v([]),E=v([]),N=v([]),x=v(!1),z=v([]),I=v(!1),j=v(null),B=R(()=>E.value.filter(e=>{var a,o;const t=(o=(a=e.file_name)==null?void 0:a.split(".").pop())==null?void 0:o.toLowerCase();return["jpg","jpeg","png","gif","webp","bmp"].includes(t)}).map(e=>({id:e.id,url:G(e.file_url),name:e.file_name,size:q(e.file_size)}))),U=R(()=>E.value.filter(e=>{var a,o;const t=(o=(a=e.file_name)==null?void 0:a.split(".").pop())==null?void 0:o.toLowerCase();return!["jpg","jpeg","png","gif","webp","bmp"].includes(t)}).map(e=>{const t=e.review_status;let a=null,o="";return e.requires_review&&(!t||t==="pending"?(a=c("chat.review_pending"),o="badge-pending"):t==="accepted"?(a=c("chat.review_accepted"),o="badge-accepted"):t==="rejected"&&(a=c("chat.review_rejected"),o="badge-rejected")),{id:e.chat_file_id||e.id,url:G(e.file_url),name:e.file_name,size:q(e.file_size),review_badge:a,review_badge_class:o}})),D=R(()=>{const e=/(https?:\/\/[^\s]+)/g,t=new Set,a=[];return N.value.forEach(o=>{if(o.type==="text"&&o.content){const l=o.content.match(e);l&&l.forEach(i=>{t.has(i)||(t.add(i),a.push({url:i,title:ee(i),message_id:o.id}))})}}),a}),J=R(()=>[{key:"media",label:c("chat.media"),count:B.value.length||null},{key:"files",label:c("chat.files"),count:U.value.length||null},{key:"links",label:c("chat.links"),count:D.value.length||null}]),V={lawyer:"chat.role_lawyer",client:"chat.role_client",expert:"chat.role_expert",company_admin:"chat.role_admin",operator:"chat.role_operator"},A=e=>{var a;const t=(a=e==null?void 0:e.user)==null?void 0:a.user_type;return t&&V[t]?c(V[t]):(e==null?void 0:e.role)||""},q=e=>{if(!e||e===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t)),l=Math.min(o,a.length-1);return Math.round(e/Math.pow(t,l)*100)/100+" "+a[l]},ee=e=>{try{return new URL(e).hostname}catch{return e}},te=()=>{X.back()},ae=async()=>{I.value=!0,x.value=!0;try{const e=await ge(g.value);z.value=e.members||[]}catch(e){console.error("获取可用成员失败:",e),M(c("chat.load_members_failed"))}finally{I.value=!1}},se=async e=>{if(j.value!==e.id){j.value=e.id;try{const t=e.user_type||"";await ke(g.value,e.id,t),M(c("chat.add_participant_success")),z.value=z.value.filter(a=>a.id!==e.id),x.value=!1;try{const o=(await Q(g.value)).participants||[];$.value=o.map(l=>{var i,k,y,w;return{id:l.user_id,name:(i=l.user)!=null&&i.first_name&&((k=l.user)!=null&&k.last_name)?`${l.user.first_name} ${l.user.last_name}`.trim():((y=l.user)==null?void 0:y.email)||"Unknown",role:A(l),avatar:((w=l.user)==null?void 0:w.avatar)||""}})}catch(a){console.error("重新加载参与者列表失败:",a)}}catch(t){const a=ye(t,c("chat.add_participant_failed"));M(a)}finally{j.value=null}}},ne=e=>{je({images:B.value.map(t=>t.url),startPosition:B.value.findIndex(t=>t.id===e.id)})},oe=e=>{var o,l;if(!e||!e.url){M(c("common.file_url_unavailable"));return}const t=(l=(o=e.name)==null?void 0:o.split(".").pop())==null?void 0:l.toLowerCase();if(["jpg","jpeg","png","gif","webp","bmp"].includes(t))window.open(e.url,"_blank");else{const i=document.createElement("a");i.href=e.url,i.download=e.name||"file",i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i),M(c("common.downloading"))}},ie=e=>{e.url&&window.open(e.url,"_blank")},le=async()=>{T.value=!0;try{const[e,t,a,o]=await Promise.all([pe(g.value),Q(g.value),he(g.value,100,0),fe(g.value,100,0)]);H.value=e.chat||e;const l=t.participants||[];$.value=l.map(i=>{var k,y,w,L;return{id:i.user_id,name:(k=i.user)!=null&&k.first_name&&((y=i.user)!=null&&y.last_name)?`${i.user.first_name} ${i.user.last_name}`.trim():((w=i.user)==null?void 0:w.email)||"Unknown",role:A(i),avatar:((L=i.user)==null?void 0:L.avatar)||""}}),E.value=a.files||[],N.value=o.messages||[]}catch(e){console.error("加载聊天详情失败:",e),M(c("chat.load_detail_failed"))}finally{T.value=!1}};return ue(()=>{le()}),(e,t)=>{const a=we,o=xe,l=be,i=Me,k=Ce,y=ze,w=Be,L=Fe;return n(),r("div",Le,[p(a,{title:m(c)("chat.chat_detail"),"left-arrow":"",onClickLeft:te},null,8,["title"]),d("div",Re,[d("h3",Pe,_(m(c)("chat.participants")),1),d("div",$e,[(n(!0),r(b,null,C($.value,(s,u)=>(n(),r("div",{key:u,class:"participant-item"},[d("div",Ee,[s.avatar?(n(),f(o,{key:0,src:m(W)(s.avatar),round:"",width:"48",height:"48"},null,8,["src"])):(n(),r("div",Ie,_(s.name?s.name[0]:"?"),1))]),d("div",Ue,[d("span",De,_(s.name),1),s.role?(n(),r("span",Se,_(s.role),1)):h("",!0)])]))),128)),m(Z).isCompanyAdmin?(n(),r("div",{key:0,class:"add-participant",onClick:ae},[p(l,{name:"plus",size:"20",color:"#0066FF"}),d("span",Te,_(m(c)("chat.add_participant")),1)])):h("",!0)])]),p(y,{active:S.value,"onUpdate:active":t[0]||(t[0]=s=>S.value=s),sticky:"","offset-top":"46"},{default:P(()=>[(n(!0),r(b,null,C(J.value,s=>(n(),f(k,{key:s.key,title:s.label,name:s.key,badge:s.count},{default:P(()=>[s.key==="media"?(n(),r("div",Ne,[B.value.length===0?(n(),f(i,{key:0,description:m(c)("chat.no_media_files")},null,8,["description"])):(n(),r("div",Ve,[(n(!0),r(b,null,C(B.value,(u,F)=>(n(),r("div",{key:F,class:"media-item",onClick:K=>ne(u)},[p(o,{src:u.url,fit:"cover",width:"100%",height:"100%"},null,8,["src"])],8,Ae))),128))]))])):h("",!0),s.key==="files"?(n(),r("div",qe,[U.value.length===0?(n(),f(i,{key:0,description:m(c)("chat.no_files")},null,8,["description"])):h("",!0),(n(!0),r(b,null,C(U.value,(u,F)=>(n(),r("div",{key:F,class:"file-item",onClick:K=>oe(u)},[p(l,{name:"description",size:"24",color:"#0066FF"}),d("div",Oe,[d("div",Ge,[d("span",Qe,_(u.name),1),u.review_badge?(n(),r("span",{key:0,class:O(["file-review-badge",u.review_badge_class])},_(u.review_badge),3)):h("",!0)]),d("span",We,_(u.size),1)]),p(l,{name:"arrow-down",size:"20",color:"#999"})],8,Ke))),128))])):h("",!0),s.key==="links"?(n(),r("div",Xe,[D.value.length===0?(n(),f(i,{key:0,description:m(c)("chat.no_links")},null,8,["description"])):h("",!0),(n(!0),r(b,null,C(D.value,(u,F)=>(n(),r("div",{key:F,class:"link-item",onClick:K=>ie(u)},[p(l,{name:"link-o",size:"20",color:"#0066FF"}),d("div",Ze,[d("span",He,_(u.title),1),d("span",Je,_(u.url),1)]),p(l,{name:"arrow",size:"16",color:"#999"})],8,Ye))),128))])):h("",!0)]),_:2},1032,["title","name","badge"]))),128))]),_:1},8,["active"]),p(L,{show:x.value,"onUpdate:show":t[2]||(t[2]=s=>x.value=s),position:"bottom",style:{height:"70%"}},{default:P(()=>[d("div",et,[d("div",tt,[d("span",at,_(m(c)("chat.select_member")),1),p(l,{name:"cross",size:"20",onClick:t[1]||(t[1]=s=>x.value=!1)})]),d("div",st,[I.value?(n(),f(w,{key:0,size:"24",vertical:""},{default:P(()=>[_e(_(m(c)("common.loading")),1)]),_:1})):z.value.length===0?(n(),f(i,{key:1,description:m(c)("chat.no_available_members")},null,8,["description"])):(n(),r("div",nt,[(n(!0),r(b,null,C(z.value,s=>(n(),r("div",{key:s.id,class:O(["member-item",{adding:j.value===s.id}]),onClick:u=>se(s)},[d("div",it,[s.avatar?(n(),f(o,{key:0,src:m(W)(s.avatar),round:"",width:"40",height:"40"},null,8,["src"])):(n(),r("div",lt,_(s.full_name?s.full_name[0]:"?"),1))]),d("div",rt,[d("span",ct,_(s.full_name),1),s.email?(n(),r("span",dt,_(s.email),1)):h("",!0)])],10,ot))),128))]))])])]),_:1},8,["show"])])}}},xt=re(ut,[["__scopeId","data-v-95374ad0"]]);export{xt as default};
