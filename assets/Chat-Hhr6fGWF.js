import{r as k,c as z,P as o,Q as i,W as n,Y as c,$ as p,j as m,Z as M,y as Y,u as j,A as De,a4 as ve,w as fe,F as ge,X as he,s as Me,a2 as Ie,E as me,a5 as be,B as _e,n as Ce,V as Ee,_ as Be,e as Le,o as Ae}from"./vue-vendor-DEVBTxx0.js";import{u as pe,o as Pe,G as Ue,l as Ne,b as qe,m as Oe}from"./index-tPAe9Dy4.js";import{C as Ve}from"./CustomNavBar-BJGtUQrX.js";import{_ as ye}from"./_plugin-vue_export-helper-BgbHP9iJ.js";/* empty css              *//* empty css              */import{_ as ke}from"./doc-0ztv5d3O.js";import{g as Re}from"./avatar-BoreVJuD.js";import{Icon as je,Loading as Ke,Image as Ge,showImagePreview as We,Tabs as He,Tab as Je,Popup as Ye,RadioGroup as Qe,Radio as Xe,Dialog as Ze,showToast as O}from"./vant-CoNmWDyF.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import{u as et}from"./useUpload-D_KmIuvU.js";import{b as tt}from"./consultation-CmWwUlcj.js";import"./index_logo-B4Lpufyb.js";const st={key:0,class:"message-divider"},at={class:"divider-text"},nt={key:1,class:"system-message-container"},it={class:"system-content"},lt={class:"system-text-wrapper"},ot={key:0,class:"system-text"},rt={class:"file-info-wrapper"},ct={key:3,class:"file-rejection-reason system-rejection"},ut={class:"rejection-text"},dt={key:4,class:"system-text"},mt={key:5,class:"system-text"},vt={key:6,class:"system-text"},ft={key:0,class:"system-actions"},gt={key:2,class:"message-item other-message"},ht={class:"message-avatar system-avatar"},yt={class:"message-content-wrapper"},wt={class:"sender-info-outside other-sender-outside"},bt={class:"sender-name"},kt={class:"message-bubble other-bubble system-bubble"},Ct={key:0,class:"text-content"},pt={class:"file-info"},jt={class:"file-name-row"},Tt={class:"file-name"},Ft={class:"file-size"},xt={class:"file-action"},$t={key:3,class:"file-rejection-reason"},St={class:"rejection-text"},Dt={class:"message-time"},_t={key:3,class:"message-item user-message"},zt={key:0,class:"sender-info-outside user-sender-outside"},Rt={class:"sender-name"},Mt={key:0,class:"sender-role"},It={class:"message-bubble user-bubble"},Et={key:0,class:"private-indicator"},Bt={class:"private-badge"},Lt={key:0,class:"private-target"},At={class:"image-error"},Pt={class:"file-info"},Ut={class:"file-name-row"},Nt={class:"file-name"},qt={key:0,class:"file-progress"},Ot={class:"progress-text"},Vt={class:"progress-bar"},Kt={key:1,class:"file-size"},Gt={class:"file-action"},Wt={key:3,class:"file-rejection-reason user-rejection"},Ht={class:"rejection-text"},Jt={key:4,class:"text-content"},Yt={class:"message-time"},Qt={key:4,class:"message-item other-message"},Xt={key:0,class:"message-avatar"},Zt=["src"],es={key:1,class:"avatar-placeholder"},ts={class:"message-content-wrapper"},ss={key:0,class:"sender-info-outside other-sender-outside"},as={class:"sender-name"},ns={key:0,class:"sender-role"},is={class:"message-bubble other-bubble"},ls={key:0,class:"private-indicator other-private"},os={class:"private-badge"},rs={key:0,class:"private-target"},cs={class:"file-info"},us={class:"file-name-row"},ds={class:"file-name"},ms={key:0,class:"file-progress"},vs={class:"progress-text"},fs={class:"progress-bar"},gs={key:1,class:"file-size"},hs={class:"file-action"},ys={key:0,class:"circular-progress"},ws={width:"24",height:"24",viewBox:"0 0 24 24"},bs=["stroke-dasharray","stroke-dashoffset"],ks={key:3,class:"file-rejection-reason"},Cs={class:"rejection-text"},ps={key:4},js={class:"text-content"},Ts={key:0,class:"translation-actions"},Fs={key:1,class:"translate-btn translating",disabled:""},xs={class:"message-time"},$s={__name:"MessageBubble",props:{message:{type:Object,required:!0},translationData:{type:Object,default:null},isTranslating:{type:Boolean,default:!1},rejectionReasonTranslation:{type:Object,default:null}},emits:["preview-document","confirm","edit","translate","show-original","translate-rejection-reason"],setup(e,{emit:N}){const u=e,T=N,{t:r}=pe(),g=k(!1),$=z(()=>2*Math.PI*10),C=z(()=>u.rejectionReasonTranslation?{[u.message.id]:u.rejectionReasonTranslation}:{}),v=k({}),x=z(()=>u.translationData&&!g.value?u.translationData.translatedText:u.message.display_content||u.message.content||""),f=z(()=>{if(u.message.type!=="system"||!u.message.content||typeof u.message.content!="string")return null;try{return JSON.parse(u.message.content)}catch{return null}}),S=z(()=>{var s;return u.message.system_type||u.message.systemType||((s=f.value)==null?void 0:s.type)||null}),B=z(()=>{var s;return u.message.system_data||u.message.systemData||((s=f.value)==null?void 0:s.data)||{}}),I=z(()=>{var s;return typeof u.message.content=="string"?u.message.content:(s=f.value)!=null&&s.message?f.value.message:""}),A=s=>s?r(`chat.consultation_status.${s}`,s):"",w=z(()=>{const s=B.value||{},t=s.name||s.user_name||r("chat.system_events.unknown_user");switch(S.value){case"lawyer_joined":return r("chat.system_events.lawyer_joined",{name:t});case"operator_joined":return r("chat.system_events.operator_joined",{name:t});case"lawyer_removed":return r("chat.system_events.lawyer_removed",{name:t});case"consultation_status_changed":{const l=A(s.from),b=A(s.to);return r("chat.system_events.consultation_status_changed",{from:l,to:b})}case"consultation_archived":return r("chat.system_events.consultation_archived");case"consultation_unarchived":return r("chat.system_events.consultation_unarchived");case"user_joined":return r("chat.system_events.user_joined",{name:t});default:return I.value||r("chat.system_events.generic")}}),F=z(()=>u.message.type==="private"||u.message.isPrivate),q=z(()=>{var t,l;if(!F.value)return"";const s=((t=u.message.privateTarget)==null?void 0:t.name)||((l=u.message.recipient)==null?void 0:l.name)||"";return u.message.isPrivateRecipient?r("chat.private_message_for_you"):s?r("chat.private_message_to",{name:s}):r("chat.private_message_generic")});function P(s){var b;const t=s.image_url||((b=s.file)==null?void 0:b.url)||s.file_url,l=t?Pe(t):null;l&&We({images:[l],startPosition:0})}function Q(s){T("preview-document",s)}function E(s){T("confirm",s)}function se(s){T("edit",s)}function W(){g.value=!1,T("translate",u.message)}function X(){g.value=!0}function Z(){g.value=!1}function ae(s){if(!s||s===0)return"0 B";const t=1024,l=["B","KB","MB","GB"],b=Math.floor(Math.log(s)/Math.log(t)),D=Math.min(b,l.length-1);return Math.round(s/Math.pow(t,D)*100)/100+" "+l[D]}function ee(s){return s.chat_files&&s.chat_files.length>0?s.chat_files[0]:s.ChatFiles&&s.ChatFiles.length>0?s.ChatFiles[0]:null}function V(s){const t=ee(s);if(!t||!t.requires_review)return null;const l=t.review_status;return!l||l==="pending"?r("chat.review_pending"):l==="accepted"?r("chat.review_accepted"):l==="rejected"?r("chat.review_rejected"):null}function U(s){const t=ee(s);if(!t)return"";const l=t.review_status;return!l||l==="pending"?"badge-pending":l==="accepted"?"badge-accepted":l==="rejected"?"badge-rejected":""}function te(s){return V(s)}function L(s){const t=ee(s);return!t||t.review_status!=="rejected"?null:t.rejection_reason||null}function ne(s){const t=L(s);return t?C.value[s.id]&&!v.value[s.id]?C.value[s.id].translatedText:t:null}function ie(s){T("translate-rejection-reason",s)}function le(s){v.value[s]=!1}function oe(s){v.value[s]=!0}return(s,t)=>{var H,a,d,h,y,R,J,K,we,re,ce,ue,de;const l=je,b=Ke,D=Ge;return e.message.type==="divider"?(i(),o("div",st,[t[16]||(t[16]=n("div",{class:"divider-line"},null,-1)),n("span",at,c(e.message.content||"ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"),1),t[17]||(t[17]=n("div",{class:"divider-line"},null,-1))])):e.message.type==="system"?(i(),o("div",nt,[n("div",{class:Y(["system-message-box",{"with-buttons":e.message.showButtons}])},[n("div",it,[m(l,{name:"service-o",size:"16",color:"#52C41A",class:"system-icon"}),n("div",lt,[e.message.type==="text"||!e.message.type?(i(),o("div",ot,c(e.message.content),1)):e.message.type==="image"&&e.message.file_url?(i(),o("div",{key:1,class:"system-image",onClick:t[0]||(t[0]=_=>P(e.message))},[m(D,{src:e.message.file_url,fit:"cover",width:"200",radius:8},{loading:M(()=>[m(b,{type:"spinner",size:"20"})]),_:1},8,["src"])])):e.message.type==="document"&&e.message.file_name?(i(),o("div",{key:2,class:"system-file",onClick:t[1]||(t[1]=_=>Q(e.message))},[m(l,{name:"description",size:"20",color:"#0066FF"}),n("div",rt,[n("span",null,c(e.message.file_name),1),V(e.message)?(i(),o("span",{key:0,class:Y(["file-review-badge",U(e.message)])},c(te(e.message)),3)):p("",!0)])])):p("",!0),e.message.type==="document"&&L(e.message)?(i(),o("div",ct,[m(l,{name:"warning-o",size:"14",color:"#FF4D4F"}),n("span",ut,c(ne(e.message)),1),L(e.message)&&!C.value[e.message.id]?(i(),o("button",{key:0,class:"translate-rejection-btn",onClick:t[2]||(t[2]=_=>ie(e.message))},c(j(r)("chat.translate")),1)):C.value[e.message.id]&&v.value[e.message.id]?(i(),o("button",{key:1,class:"translate-rejection-btn",onClick:t[3]||(t[3]=_=>le(e.message.id))},c(j(r)("chat.show_translation")),1)):C.value[e.message.id]&&!v.value[e.message.id]?(i(),o("button",{key:2,class:"translate-rejection-btn",onClick:t[4]||(t[4]=_=>oe(e.message.id))},c(j(r)("chat.show_original")),1)):p("",!0)])):e.message.file?(i(),o("div",dt,[m(l,{name:"paperclip",size:"14",color:"#0066FF"}),n("span",null,c(e.message.file),1)])):e.message.action?(i(),o("div",mt,[m(l,{name:"success",size:"14",color:"#52C41A"}),n("span",null,c(e.message.action),1)])):(i(),o("div",vt,c(w.value),1))])]),e.message.showButtons?(i(),o("div",ft,[n("button",{class:"btn-confirm",onClick:t[5]||(t[5]=_=>E(e.message))},c(s.$t("common.confirm")),1),n("button",{class:"btn-edit",onClick:t[6]||(t[6]=_=>se(e.message))},c(s.$t("common.edit")),1)])):p("",!0)],2)])):!e.message.sender_id&&!e.message.sender&&e.message.type!=="system"?(i(),o("div",gt,[n("div",ht,[m(l,{name:"service-o",size:"20",color:"#52C41A"})]),n("div",yt,[n("div",wt,[n("span",bt,c(j(r)("chat.system_message")),1)]),n("div",kt,[e.message.type==="text"||!e.message.type?(i(),o("div",Ct,c(e.message.content),1)):e.message.type==="image"?(i(),o("div",{key:1,class:"image-message",onClick:t[7]||(t[7]=_=>P(e.message))},[m(D,{src:e.message.file_url,fit:"cover",width:"200",radius:8},{loading:M(()=>[m(b,{type:"spinner",size:"20"})]),error:M(()=>[...t[18]||(t[18]=[n("div",{class:"image-error"},"åŠ è½½å¤±è´¥",-1)])]),_:1},8,["src"])])):e.message.type==="file"||e.message.type==="document"?(i(),o("div",{key:2,class:"file-attachment other-file",onClick:t[8]||(t[8]=_=>Q(e.message))},[t[19]||(t[19]=n("img",{src:ke,class:"file-icon"},null,-1)),n("div",pt,[n("div",jt,[n("span",Tt,c(e.message.file_name||"Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚"),1),V(e.message)?(i(),o("span",{key:0,class:Y(["file-review-badge",U(e.message)])},c(te(e.message)),3)):p("",!0)]),n("span",Ft,c(ae(e.message.file_size)),1)]),n("div",xt,[m(l,{name:"arrow-down",size:"18",color:"#0066FF"})])])):p("",!0),(e.message.type==="file"||e.message.type==="document")&&L(e.message)?(i(),o("div",$t,[m(l,{name:"warning-o",size:"14",color:"#FF4D4F"}),n("span",St,c(L(e.message)),1)])):p("",!0)]),n("span",Dt,c(e.message.time),1)])])):e.message.isMe?(i(),o("div",_t,[e.message.sender?(i(),o("div",zt,[n("span",Rt,c(e.message.sender.name),1),e.message.sender.role?(i(),o("span",Mt,"["+c(e.message.sender.role)+"]",1)):p("",!0)])):p("",!0),n("div",It,[F.value?(i(),o("div",Et,[m(l,{name:"lock",size:"14"}),n("span",Bt,c(j(r)("chat.private_badge")),1),q.value?(i(),o("span",Lt,c(q.value),1)):p("",!0)])):p("",!0),e.message.type==="image"?(i(),o("div",{key:1,class:"image-message",onClick:t[9]||(t[9]=_=>P(e.message))},[m(D,{src:e.message.image_url||((H=e.message.file)==null?void 0:H.url)||e.message.file_url,fit:"cover",width:"200",radius:8},{loading:M(()=>[m(b,{type:"spinner",size:"20"})]),error:M(()=>[n("div",At,c(j(r)("common.load_failed")),1)]),_:1},8,["src"])])):e.message.type==="file"||e.message.type==="document"?(i(),o("div",{key:2,class:"file-attachment",onClick:t[10]||(t[10]=_=>Q(e.message))},[t[20]||(t[20]=n("img",{src:ke,class:"file-icon"},null,-1)),n("div",Pt,[n("div",Ut,[n("span",Nt,c(((a=e.message.file)==null?void 0:a.name)||((d=e.message.document)==null?void 0:d.name)||"Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚"),1),V(e.message)?(i(),o("span",{key:0,class:Y(["file-review-badge user-file-badge",U(e.message)])},c(te(e.message)),3)):p("",!0)]),(h=e.message.file)!=null&&h.progress?(i(),o("div",qt,[n("span",Ot,c(e.message.file.progress),1),n("div",Vt,[n("div",{class:"progress-fill",style:De({width:e.message.file.progressPercent+"%"})},null,4)])])):(i(),o("span",Kt,c(((y=e.message.file)==null?void 0:y.size)||((R=e.message.document)==null?void 0:R.size)||"0 MB"),1))]),n("div",Gt,[m(l,{name:"arrow-down",size:"18",color:"rgba(255,255,255,0.8)"})])])):p("",!0),(e.message.type==="file"||e.message.type==="document")&&L(e.message)?(i(),o("div",Wt,[m(l,{name:"warning-o",size:"14",color:"rgba(255,255,255,0.9)"}),n("span",Ht,c(ne(e.message)),1),L(e.message)&&!C.value[e.message.id]?(i(),o("button",{key:0,class:"translate-rejection-btn user-rejection-btn",onClick:t[11]||(t[11]=_=>ie(e.message))},c(j(r)("chat.translate")),1)):C.value[e.message.id]&&v.value[e.message.id]?(i(),o("button",{key:1,class:"translate-rejection-btn user-rejection-btn",onClick:t[12]||(t[12]=_=>le(e.message.id))},c(j(r)("chat.show_translation")),1)):C.value[e.message.id]&&!v.value[e.message.id]?(i(),o("button",{key:2,class:"translate-rejection-btn user-rejection-btn",onClick:t[13]||(t[13]=_=>oe(e.message.id))},c(j(r)("chat.show_original")),1)):p("",!0)])):e.message.type!=="image"&&e.message.type!=="file"&&e.message.type!=="document"?(i(),o("div",Jt,c(e.message.content),1)):p("",!0)]),n("span",Yt,c(e.message.time),1)])):(i(),o("div",Qt,[e.message.sender?(i(),o("div",Xt,[e.message.sender.avatar?(i(),o("img",{key:0,src:j(Re)(e.message.sender.avatar),class:"avatar-img"},null,8,Zt)):(i(),o("div",es,[m(l,{name:"contact",size:"20",color:"#FFFFFF"})]))])):p("",!0),n("div",ts,[e.message.sender?(i(),o("div",ss,[n("span",as,c(e.message.sender.name),1),e.message.sender.role?(i(),o("span",ns,"["+c(e.message.sender.role)+"]",1)):p("",!0)])):p("",!0),n("div",is,[F.value?(i(),o("div",ls,[m(l,{name:"lock",size:"14"}),n("span",os,c(j(r)("chat.private_badge")),1),q.value?(i(),o("span",rs,c(q.value),1)):p("",!0)])):p("",!0),e.message.type==="image"?(i(),o("div",{key:1,class:"image-message",onClick:t[14]||(t[14]=_=>P(e.message))},[m(D,{src:e.message.image_url||((J=e.message.file)==null?void 0:J.url)||e.message.file_url,fit:"cover",width:"200",radius:8},{loading:M(()=>[m(b,{type:"spinner",size:"20"})]),error:M(()=>[...t[21]||(t[21]=[n("div",{class:"image-error"},"åŠ è½½å¤±è´¥",-1)])]),_:1},8,["src"])])):e.message.type==="file"||e.message.type==="document"?(i(),o("div",{key:2,class:"file-attachment other-file",onClick:t[15]||(t[15]=_=>Q(e.message))},[t[23]||(t[23]=n("img",{src:ke,class:"file-icon"},null,-1)),n("div",cs,[n("div",us,[n("span",ds,c(((K=e.message.file)==null?void 0:K.name)||((we=e.message.document)==null?void 0:we.name)||"Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚"),1),V(e.message)?(i(),o("span",{key:0,class:Y(["file-review-badge",U(e.message)])},c(te(e.message)),3)):p("",!0)]),(re=e.message.file)!=null&&re.progress?(i(),o("div",ms,[n("span",vs,c(e.message.file.progress),1),n("div",fs,[n("div",{class:"progress-fill",style:De({width:e.message.file.progressPercent+"%"})},null,4)])])):(i(),o("span",gs,c(((ce=e.message.file)==null?void 0:ce.size)||((ue=e.message.document)==null?void 0:ue.size)||"0 MB"),1))]),n("div",hs,[(de=e.message.file)!=null&&de.progress?(i(),o("div",ys,[(i(),o("svg",ws,[t[22]||(t[22]=n("circle",{cx:"12",cy:"12",r:"10",fill:"none",stroke:"#E5E9F0","stroke-width":"2"},null,-1)),n("circle",{cx:"12",cy:"12",r:"10",fill:"none",stroke:"#0066FF","stroke-width":"2","stroke-dasharray":$.value,"stroke-dashoffset":$.value-$.value*e.message.file.progressPercent/100,transform:"rotate(-90 12 12)"},null,8,bs)]))])):(i(),ve(l,{key:1,name:"arrow-down",size:"18",color:"#0066FF"}))])])):p("",!0),(e.message.type==="file"||e.message.type==="document")&&L(e.message)?(i(),o("div",ks,[m(l,{name:"warning-o",size:"14",color:"#FF4D4F"}),n("span",Cs,c(L(e.message)),1)])):e.message.type!=="image"&&e.message.type!=="file"&&e.message.type!=="document"?(i(),o("div",ps,[n("div",js,c(x.value),1),e.message.type==="text"||!e.message.type?(i(),o("div",Ts,[!e.translationData&&!e.isTranslating?(i(),o("button",{key:0,class:"translate-btn",onClick:W},[m(l,{name:"guide-o",size:"12"}),n("span",null,c(j(r)("chat.translate")),1)])):e.isTranslating?(i(),o("button",Fs,[m(b,{type:"spinner",size:"12"}),n("span",null,c(j(r)("chat.translating")),1)])):e.translationData&&!g.value?(i(),o("button",{key:2,class:"translate-btn show-original",onClick:X},[m(l,{name:"eye-o",size:"12"}),n("span",null,c(j(r)("chat.show_original")),1)])):e.translationData&&g.value?(i(),o("button",{key:3,class:"translate-btn",onClick:Z},[m(l,{name:"guide-o",size:"12"}),n("span",null,c(j(r)("chat.translate")),1)])):p("",!0)])):p("",!0)])):p("",!0)]),n("span",xs,c(e.message.time),1)])]))}}},Ss=ye($s,[["__scopeId","data-v-a6bc99cd"]]),Ds={class:"emoji-picker"},_s={class:"emoji-header"},zs={class:"emoji-title"},Rs={class:"emoji-grid"},Ms=["onClick"],Is={class:"emoji-grid"},Es=["onClick"],Bs={__name:"EmojiPicker",props:{show:{type:Boolean,default:!1}},emits:["update:show","select"],setup(e,{emit:N}){const u=e,T=N,r=k(u.show),g=k("emoji"),$=["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜™","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ¤¥","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ¥µ","ðŸ¥¶","ðŸ˜µ","ðŸ¤¯","ðŸ¤ ","ðŸ¥³","ðŸ˜Ž","ðŸ¤“","ðŸ§","ðŸ˜•","ðŸ˜Ÿ","ðŸ™","ðŸ˜®","ðŸ˜¯","ðŸ˜²","ðŸ˜³","ðŸ¥º","ðŸ˜¦","ðŸ˜§","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜¢","ðŸ˜­","ðŸ˜±","ðŸ˜–","ðŸ˜£","ðŸ˜ž","ðŸ˜“","ðŸ˜©","ðŸ˜«","ðŸ¥±","ðŸ˜¤","ðŸ˜¡","ðŸ˜ ","ðŸ¤¬","ðŸ‘","ðŸ‘Ž","ðŸ‘Š","âœŠ","ðŸ¤›","ðŸ¤œ","ðŸ¤ž","âœŒï¸","ðŸ¤Ÿ","ðŸ¤˜","ðŸ‘Œ","ðŸ¤","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ‘‡","â˜ï¸","âœ‹","ðŸ¤š","ðŸ–ï¸","ðŸ––","ðŸ‘‹","ðŸ¤™","ðŸ’ª","ðŸ™"],C=["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â˜®ï¸","âœï¸","â˜ªï¸","ðŸ•‰ï¸","â˜¸ï¸","âœ¡ï¸","ðŸ”¯","ðŸ•Ž","â˜¯ï¸","â˜¦ï¸","ðŸ›","â›Ž","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™Ž","â™","â™","â™‘","â™’","â™“","ðŸ†”","âš›ï¸","ðŸ‰‘","â˜¢ï¸","â˜£ï¸","ðŸ“´","ðŸ“³","ðŸˆ¶","ðŸˆš","ðŸˆ¸","ðŸˆº","ðŸˆ·ï¸","âœ´ï¸","ðŸ†š","ðŸ’®","ðŸ‰","ãŠ™ï¸","ãŠ—ï¸","ðŸˆ´","ðŸˆµ","ðŸˆ¹","ðŸˆ²","ðŸ…°ï¸","ðŸ…±ï¸","ðŸ†Ž","ðŸ†‘","ðŸ…¾ï¸","ðŸ†˜","âŒ","â­•","ðŸ›‘","â›”","ðŸ“›","ðŸš«","ðŸ’¯","ðŸ’¢","â™¨ï¸","ðŸš·","ðŸš¯","ðŸš³","ðŸš±","ðŸ”ž","ðŸ“µ","ðŸš­","â—","â•","â“","â”","â€¼ï¸","â‰ï¸","ðŸ”…","ðŸ”†","ã€½ï¸","âš ï¸","ðŸš¸","ðŸ”±","âšœï¸","ðŸ”°","â™»ï¸","âœ…","ðŸˆ¯","ðŸ’¹"];fe(()=>u.show,f=>{r.value=f}),fe(r,f=>{T("update:show",f)});function v(){r.value=!1}function x(f){T("select",f)}return(f,S)=>{const B=je,I=Je,A=He,w=Ye;return i(),ve(w,{show:r.value,"onUpdate:show":S[1]||(S[1]=F=>r.value=F),position:"bottom",style:{height:"360px"},round:"",onClose:v},{default:M(()=>[n("div",Ds,[n("div",_s,[n("span",zs,c(f.t("chat.emoji")),1),m(B,{name:"cross",size:"20",onClick:v})]),m(A,{active:g.value,"onUpdate:active":S[0]||(S[0]=F=>g.value=F),class:"emoji-tabs"},{default:M(()=>[m(I,{title:`ðŸ˜Š ${f.t("chat.emoji")}`,name:"emoji"},{default:M(()=>[n("div",Rs,[(i(),o(ge,null,he($,F=>n("div",{key:F,class:"emoji-item",onClick:q=>x(F)},c(F),9,Ms)),64))])]),_:1},8,["title"]),m(I,{title:`ðŸŽ‰ ${f.t("chat.symbols")}`,name:"symbol"},{default:M(()=>[n("div",Is,[(i(),o(ge,null,he(C,F=>n("div",{key:F,class:"emoji-item",onClick:q=>x(F)},c(F),9,Es)),64))])]),_:1},8,["title"])]),_:1},8,["active"])])]),_:1},8,["show"])}}},Ls=ye(Bs,[["__scopeId","data-v-bc84bc78"]]),As={key:0,class:"disabled-overlay"},Ps={class:"disabled-text"},Us={class:"input-wrapper"},Ns={class:"input-field-wrapper"},qs=["placeholder","disabled"],Os={key:0,class:"mention-dropdown"},Vs=["onMousedown"],Ks={class:"mention-handle"},Gs={class:"mention-name"},Ws={key:0,class:"mention-empty"},Hs=["disabled"],Js={class:"review-dialog-content"},Ys={class:"file-info"},Qs={class:"file-name"},Xs={__name:"MessageInput",props:{disabled:{type:Boolean,default:!1},disabledMessage:{type:String,default:""},participants:{type:Array,default:()=>[]},currentUserType:{type:String,default:""}},emits:["send-text","attach-file"],setup(e,{emit:N}){const u=e,T=N,{t:r}=pe(),g=k(""),$=k(null),C=k(null),v=k(!1),x=k(!1),f=k(0),S=k(!1),B=k(null),I=k("false"),A=z(()=>["lawyer","operator"].includes(u.currentUserType)),w=z(()=>u.currentUserType==="lawyer"?"operator":u.currentUserType==="operator"?"lawyer":""),F=s=>{var l;const t=(((l=s==null?void 0:s.user)==null?void 0:l.user_type)||(s==null?void 0:s.role)||"").toString().toLowerCase().trim();return t?t.includes("lawyer")?"lawyer":t.includes("operator")?"operator":t.includes("client")?"client":t.includes("expert")?"expert":t:""},q=s=>{var t;return s?((t=s.user)==null?void 0:t.id)??s.user_id??s.id??null:null},P=z(()=>!A.value||!w.value?[]:u.participants.map(s=>{if(F(s)!==w.value)return null;const l=q(s);if(!l)return null;const b=s.user||{},D=`${b.first_name||""} ${b.last_name||""}`.trim()||b.email||`${w.value} ${l}`;return{id:l,name:D,handle:`#${w.value}${l}`}}).filter(Boolean)),Q=z(()=>{if(!A.value)return"";const s=g.value.trimStart();return s.startsWith("#")?(s.split(/\s+/)[0]||"").slice(1).toLowerCase():""}),E=z(()=>{const s=Q.value;return!s&&!g.value.trimStart().startsWith("#")?[]:P.value.filter(t=>{if(!t)return!1;if(!s)return!0;const l=t.handle.toLowerCase(),b=t.name.toLowerCase();return l.includes(s)||b.includes(s)})});fe([()=>g.value,P],()=>{if(!A.value){x.value=!1,f.value=0;return}const s=g.value.trimStart().startsWith("#");x.value=s,f.value=E.value.length>0?0:-1});function se(){if(!A.value){x.value=!1;return}const s=g.value.trimStart().startsWith("#");x.value=s,s&&E.value.length>0?f.value=0:f.value=-1}function W(){x.value=!1,f.value=0}function X(s){if(!s)return;const l=g.value.trimStart().split(/\s+/);l.shift();const b=l.join(" ");g.value=b?`${s.handle} ${b}`:`${s.handle} `,x.value=!1,Ce(()=>{$.value&&($.value.focus(),$.value.setSelectionRange(g.value.length,g.value.length))})}function Z(s){if(!x.value||E.value.length===0)return;const t=E.value.length;if(f.value<0){f.value=0;return}s==="down"?f.value=(f.value+1)%t:f.value=(f.value-1+t)%t}function ae(s){if(!x.value)return;if(E.value.length===0){s.preventDefault();return}s.preventDefault();const t=f.value>=0?f.value:0,l=E.value[t];X(l)}function ee(){u.disabled||!g.value.trim()||(T("send-text",g.value.trim()),g.value="",W())}function V(s){if(x.value&&E.value.length>0){s.preventDefault();return}ee()}function U(){u.disabled||(v.value=!1,C.value&&C.value.click())}function te(){u.disabled||(g.value.trim()?ee():U())}function L(s){var l;if(u.disabled)return;const t=(l=s.target.files)==null?void 0:l[0];t&&(u.currentUserType==="lawyer"?(B.value=t,I.value="false",S.value=!0):(T("attach-file",t,!1),C.value&&(C.value.value="")))}function ne(){if(B.value){const s=I.value==="true";T("attach-file",B.value,s),S.value=!1,B.value=null,I.value="false",C.value&&(C.value.value="")}}function ie(){S.value=!1,B.value=null,I.value="false",C.value&&(C.value.value="")}function le(){u.disabled||(v.value=!v.value)}function oe(s){const t=$.value;if(!t){g.value+=s;return}const l=t.selectionStart||0,b=t.selectionEnd||0,D=g.value;g.value=D.slice(0,l)+s+D.slice(b),Ce(()=>{const H=l+s.length;t.setSelectionRange(H,H),t.focus()})}return(s,t)=>{const l=je,b=Xe,D=Qe,H=Ze;return i(),o("div",{class:Y(["input-container",{"is-disabled":e.disabled}])},[e.disabled?(i(),o("div",As,[m(l,{name:"info-o",size:"16",color:"#95A5A6"}),n("span",Ps,c(e.disabledMessage||j(r)("chat.input_disabled")),1)])):p("",!0),n("div",Us,[n("div",{class:Y(["emoji-button",{disabled:e.disabled}]),onClick:le},[m(l,{name:"smile-o",size:"20",color:e.disabled?"#C0C4CC":v.value?"#0066FF":"#7A8794"},null,8,["color"])],2),n("div",Ns,[Me(n("input",{ref_key:"inputRef",ref:$,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value=a),type:"text",class:"message-input",placeholder:e.disabled?e.disabledMessage||j(r)("chat.input_disabled"):j(r)("chat.type_message")||"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",disabled:e.disabled,onKeyup:me(V,["enter"]),onFocus:t[1]||(t[1]=a=>v.value=!1),onKeydown:[t[2]||(t[2]=me(be(a=>Z("down"),["prevent"]),["down"])),t[3]||(t[3]=me(be(a=>Z("up"),["prevent"]),["up"])),me(ae,["enter"]),me(W,["esc"])],onInput:se},null,40,qs),[[Ie,g.value]]),x.value?(i(),o("div",Os,[(i(!0),o(ge,null,he(E.value,(a,d)=>(i(),o("div",{key:a.handle,class:Y(["mention-option",{active:d===f.value}]),onMousedown:be(h=>X(a),["prevent"])},[n("span",Ks,c(a.handle),1),n("span",Gs,c(a.name),1)],42,Vs))),128)),E.value.length===0?(i(),o("div",Ws,c(j(r)("chat.no_available_targets")),1)):p("",!0)])):p("",!0)]),n("div",{class:Y(["file-send-button",{"has-text":g.value.length>0,disabled:e.disabled}]),onClick:te},[g.value.length===0?(i(),ve(l,{key:0,name:"plus",size:"20",color:e.disabled?"#C0C4CC":"#7A8794"},null,8,["color"])):(i(),ve(l,{key:1,name:"arrow-up",size:"20",color:e.disabled?"#C0C4CC":"#FFFFFF"},null,8,["color"]))],2),n("input",{ref_key:"fileInputRef",ref:C,type:"file",style:{display:"none"},disabled:e.disabled,onChange:L,accept:"*/*"},null,40,Hs)]),m(Ls,{show:v.value,"onUpdate:show":t[4]||(t[4]=a=>v.value=a),onSelect:oe},null,8,["show"]),m(H,{show:S.value,"onUpdate:show":t[6]||(t[6]=a=>S.value=a),title:j(r)("chat.file_review_title"),"show-cancel-button":!0,"show-confirm-button":!0,"cancel-button-text":j(r)("common.cancel"),"confirm-button-text":j(r)("common.confirm"),onConfirm:ne,onCancel:ie},{default:M(()=>{var a;return[n("div",Js,[n("div",Ys,[m(l,{name:"description",size:"24",color:"#0066FF"}),n("span",Qs,c((a=B.value)==null?void 0:a.name),1)]),m(D,{modelValue:I.value,"onUpdate:modelValue":t[5]||(t[5]=d=>I.value=d),direction:"horizontal",class:"review-options"},{default:M(()=>[m(b,{name:"false"},{default:M(()=>[_e(c(j(r)("chat.no_review_required")),1)]),_:1}),m(b,{name:"true"},{default:M(()=>[_e(c(j(r)("chat.require_client_review")),1)]),_:1})]),_:1},8,["modelValue"])])]}),_:1},8,["show","title","cancel-button-text","confirm-button-text"])],2)}}},Zs=ye(Xs,[["__scopeId","data-v-78aab471"]]),ze=async(e,N,u=null)=>{var g;if(!e||!e.trim())throw new Error("ç¿»è¯‘æ–‡æœ¬ä¸èƒ½ä¸ºç©º");const T={"zh-Hans":"zh-CN",zh:"zh-CN",kk:"kk",ru:"ru",en:"en"},r=T[N]||N;try{const $={q:e,target:r,format:"text"};u&&($.source=T[u]||u);const C=await fetch(`https://translation.googleapis.com/language/translate/v2?key=${Ue}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!C.ok){const f=await C.json().catch(()=>({}));throw new Error(((g=f.error)==null?void 0:g.message)||`ç¿»è¯‘è¯·æ±‚å¤±è´¥: ${C.status}`)}const v=await C.json();if(!v.data||!v.data.translations||v.data.translations.length===0)throw new Error("ç¿»è¯‘ç»“æžœä¸ºç©º");const x=v.data.translations[0];return{translatedText:x.translatedText,detectedSourceLanguage:x.detectedSourceLanguage||u,originalText:e,targetLanguage:r}}catch($){throw console.error("ç¿»è¯‘å¤±è´¥:",$),$}},ea={class:"chat-page-wrapper"},ta={class:"chat-page"},sa={__name:"Chat",setup(e){const N=Ee(),u=Be(),T=Ne(),r=qe(),{selectDocument:g}=et(),{connect:$,send:C}=Oe(),{t:v,locale:x}=pe(),f=k(null),S=k([]),B=k(""),I=k(""),A=k(""),w=k(null),F=k(!1),q=k(!1),P=k(null),Q=k(null),E=k(!1),se=k(""),W=k({}),X=k(new Set),Z=k({}),ae=k(new Set),ee=z(()=>{if(!w.value)return[];const a=T.chats.find(d=>d.id===w.value);return(a==null?void 0:a.participants)||[]}),V=z(()=>r.targetLanguage||x.value);function U(){Ce(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})}function te(a){w.value&&T.sendMessage(w.value,a,"text").then(()=>{U()}).catch(d=>{console.error("Failed to send message:",d),O(v("common.send_failed"))})}async function L(a,d=!1){try{a||(a=await g()),a&&w.value&&(O(v("common.uploading")),T.uploadFile(w.value,a,d).then(()=>{U(),O(v("common.upload_success"))}).catch(h=>{console.error("Failed to upload file:",h),O(v("common.upload_failed"))}))}catch(h){console.error(v("common.file_select_failed"),h)}}function ne(a){var re,ce,ue,de,_,Te,Fe,xe,$e,Se;const d=((re=a.file)==null?void 0:re.url)||((ce=a.document)==null?void 0:ce.url),h=((ue=a.file)==null?void 0:ue.name)||((de=a.document)==null?void 0:de.name)||"file";if(!d){O(v("common.file_url_unavailable"));return}const y=((_=a.chat_files)==null?void 0:_[0])||((Te=a.ChatFiles)==null?void 0:Te[0])||((Fe=a.chatFiles)==null?void 0:Fe[0])||(a.chat_files&&Array.isArray(a.chat_files)?a.chat_files[0]:null)||(a.ChatFiles&&Array.isArray(a.ChatFiles)?a.ChatFiles[0]:null),R=r.userType||((xe=r.user)==null?void 0:xe.user_type),J=R==="company_admin"||R==="expert";if(console.log("previewDocument - message:",a),console.log("previewDocument - message.chat_files:",a.chat_files),console.log("previewDocument - message.ChatFiles:",a.ChatFiles),console.log("previewDocument - chatFile:",y),console.log("previewDocument - userStore.user:",r.user),console.log("previewDocument - userStore.userType:",r.userType),console.log("previewDocument - userStore.user?.user_type:",($e=r.user)==null?void 0:$e.user_type),console.log("previewDocument - userType:",R),console.log("previewDocument - isClient:",J),console.log("previewDocument - requires_review:",y==null?void 0:y.requires_review),console.log("previewDocument - review_status:",y==null?void 0:y.review_status),y&&y.requires_review&&(!y.review_status||y.review_status==="pending")&&J){const G=y.chat_file_id||y.id||y.ID;if(console.log("previewDocument - fileId:",G),!G)console.warn("ChatFile ID not found, downloading directly");else{console.log("previewDocument - Navigating to FileDetail page"),N.push({name:"FileDetail",params:{id:w.value,fileId:G}});return}}else console.log("previewDocument - Conditions not met, downloading directly"),y||console.warn("previewDocument - No ChatFile found in message"),J||console.log("previewDocument - User is not a client");const K=(Se=h.split(".").pop())==null?void 0:Se.toLowerCase();if(["jpg","jpeg","png","gif","webp","bmp"].includes(K))window.open(d,"_blank");else{const G=document.createElement("a");G.href=d,G.download=h,G.target="_blank",document.body.appendChild(G),G.click(),document.body.removeChild(G),O(v("common.downloading")||"æ­£åœ¨ä¸‹è½½...")}}function ie(){N.push({name:"ChatDetail",params:{id:w.value}})}function le(){const a=!r.autoTranslateEnabled;r.toggleAutoTranslate(a),a?(O(v("chat.auto_translate_enabled")),S.value.forEach(d=>{D(d)})):O(v("chat.auto_translate_disabled"))}async function oe(){if(P.value)try{const a=await tt(P.value),d=a.consultation||a;Q.value=d.status,d.status==="archived"&&(E.value=!0,se.value=v("consultation.archived"))}catch(a){console.error("Failed to check consultation status:",a)}}async function s(){var a;if(w.value){q.value=!0;try{await T.fetchMessages(w.value);const d=T.messages[w.value]||[],h=T.chats.find(y=>y.id===w.value);h&&(I.value=h.name||"",A.value=h.avatar?Re(h.avatar):"",F.value=h.type==="group"||((a=h.participants)==null?void 0:a.length)>2),S.value=d,await T.markAsRead(w.value),U()}catch(d){console.error("Failed to load messages:",d),O(v("common.load_messages_failed"))}finally{q.value=!1}}}const t=a=>a?a.type?a.type==="text"||a.type==="private":!0:!1,l=a=>(a==null?void 0:a.display_content)||(a==null?void 0:a.content)||(a==null?void 0:a.text)||"";async function b(a){if(W.value[a.id]||a.isMe||!t(a))return;const d=l(a);if(!(!d||!d.trim())){X.value.add(a.id);try{const h=await ze(d,V.value);W.value[a.id]={translatedText:h.translatedText,originalText:d,targetLang:h.targetLanguage,detectedSourceLang:h.detectedSourceLanguage,timestamp:Date.now()}}catch(h){console.error("ç¿»è¯‘å¤±è´¥:",h),O(v("chat.translation_failed"))}finally{X.value.delete(a.id)}}}async function D(a){if(!r.autoTranslateEnabled||a.isMe||!t(a))return;const d=l(a);!d||!d.trim()||W.value[a.id]||await b(a)}fe(()=>T.messages[w.value],(a,d)=>{if(!(!a||!w.value))if(S.value=a.map(h=>({...h,showSenderInBubble:F.value})),d&&r.autoTranslateEnabled){const h=new Set(d.map(R=>R.id)),y=a.filter(R=>!h.has(R.id));y.length>0&&(y.forEach(R=>{D(R)}),U())}else d&&a.length>d.length&&U()},{deep:!0});async function H(a){var R,J;const d=((R=a.chat_files)==null?void 0:R[0])||((J=a.ChatFiles)==null?void 0:J[0]);if(!d||!d.rejection_reason)return;const h=a.id,y=d.rejection_reason;if(!Z.value[h]){ae.value.add(h);try{const K=await ze(y,V.value);Z.value[h]={translatedText:K.translatedText,originalText:y,targetLang:K.targetLanguage,detectedSourceLang:K.detectedSourceLanguage,timestamp:Date.now()}}catch(K){console.error("ç¿»è¯‘æ‹’ç»åŽŸå› å¤±è´¥:",K),O(v("chat.translation_failed"))}finally{ae.value.delete(h)}}}return Le(()=>{B.value=u.query.title?decodeURIComponent(u.query.title):v("chat.conversation");const a=parseInt(u.params.id||u.query.chatId);if(w.value=isNaN(a)?null:a,u.query.consultation_id||u.query.consultationId){const d=parseInt(u.query.consultation_id||u.query.consultationId);P.value=isNaN(d)?null:d,P.value&&oe()}$(),s().then(()=>{r.autoTranslateEnabled&&S.value.forEach(d=>{D(d)})}),w.value&&C({type:"join_chat",chat_id:w.value}).catch(d=>{console.error("Failed to join chat via WebSocket:",d)})}),Ae(()=>{w.value&&(T.markAsRead(w.value),C({type:"leave_chat",chat_id:w.value}))}),(a,d)=>{var h;return i(),o("div",ea,[m(Ve,{title:B.value,subtitle:I.value,avatar:A.value,"is-group":F.value,"show-logo":!1,"show-bell":!1,"show-avatar":!0,"show-menu":!0,"show-translate":!0,"translate-enabled":j(r).autoTranslateEnabled,onMenuClick:ie,onTranslateClick:le},null,8,["title","subtitle","avatar","is-group","translate-enabled"]),n("div",ta,[n("div",{class:"messages-container",ref_key:"messagesContainer",ref:f},[(i(!0),o(ge,null,he(S.value,y=>(i(),ve(Ss,{key:y.id,message:y,"translation-data":W.value[y.id],"is-translating":X.value.has(y.id),"rejection-reason-translation":Z.value[y.id],onPreviewDocument:ne,onTranslate:b,onTranslateRejectionReason:H},null,8,["message","translation-data","is-translating","rejection-reason-translation"]))),128))],512),m(Zs,{disabled:E.value,"disabled-message":se.value,participants:ee.value,"current-user-type":(h=j(r).user)==null?void 0:h.user_type,onSendText:te,onAttachFile:L},null,8,["disabled","disabled-message","participants","current-user-type"])])])}}},Ca=ye(sa,[["__scopeId","data-v-be7f424f"]]);export{Ca as default};
